<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Detail Materi - Edunet">
    <title>Materi - Edunet</title>
    <link rel="icon" type="image/png" href="/public/img/logos/edunet-logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/src/styles/main.css">
    <link rel="stylesheet" href="/src/styles/pages.css">
    <link rel="stylesheet" href="/src/styles/material.css">

</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container nav-container">
            <a href="/" class="logo">
                <img src="/public/img/logos/edunet-logo.png" alt="Edunet Logo" class="logo-icon logo-img">
                <span class="logo-text">Edunet</span>
            </a>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span class="hamburger"></span>
            </button>
            <ul class="nav-menu" id="navMenu">
                <li><a href="/" class="nav-link">Beranda</a></li>
                <li class="nav-dropdown">
                    <a href="#" class="nav-link">Kelas</a>
                    <ul class="dropdown-menu">
                        <li><a href="/pages/kelas-10.html" class="dropdown-link">Kelas 10</a></li>
                        <li><a href="/pages/kelas-11.html" class="dropdown-link">Kelas 11</a></li>
                        <li><a href="/pages/kelas-12.html" class="dropdown-link">Kelas 12</a></li>
                    </ul>
                </li>
                <li><a href="/pages/quiz.html" class="nav-link">Quiz</a></li>
                <li><a href="/pages/forum.html" class="nav-link">Forum</a></li>
                <li><a href="/pages/lab-virtual.html" class="nav-link">Lab Virtual</a></li>
            </ul>
            <button class="search-btn" id="searchBtn" aria-label="Search">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <span class="search-shortcut">Ctrl+K</span>
            </button>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loadingState" class="material-header"
        style="min-height: 50vh; display: flex; align-items: center; justify-content: center;">
        <div class="container" style="text-align: center;">
            <div class="spinner"
                style="width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem;">
            </div>
            <p style="color: var(--text-secondary);">Memuat materi...</p>
        </div>
    </div>

    <!-- Content Container -->
    <div id="contentContainer" style="display: none;">
        <!-- Material Header -->
        <header class="material-header" id="materialHeader"></header>

        <!-- Main Content -->
        <main class="material-main">
            <div class="container">
                <div class="material-layout">
                    <!-- Article Content -->
                    <article class="material-article" id="materialArticle"></article>

                    <!-- Sidebar -->
                    <aside class="material-sidebar" id="materialSidebar"></aside>
                </div>
            </div>
        </main>

        <!-- Navigation Buttons -->
        <section class="material-nav" id="materialNav"></section>
    </div>

    <!-- Error State -->
    <div id="errorState"
        style="display: none; min-height: 80vh; display: flex; align-items: center; justify-content: center;">
        <div class="container" style="text-align: center;">
            <i class="bi bi-emoji-frown"
                style="font-size: 4rem; color: var(--text-muted); margin-bottom: 1rem; display: block;"></i>
            <h2 style="font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5rem;">Materi Tidak Ditemukan
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Materi yang Anda cari tidak tersedia atau
                telah dihapus.</p>
            <a href="/" class="btn btn-primary">
                <i class="bi bi-house"></i> Kembali ke Beranda
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <a href="/" class="logo">
                        <img src="/public/img/logos/edunet-logo.png" alt="Edunet Logo" class="logo-icon logo-img">
                        <span class="logo-text">Edunet</span>
                    </a>
                    <p>Portal belajar TKJ terlengkap untuk siswa SMK Indonesia.</p>
                </div>
                <div class="footer-links">
                    <h4>Navigasi</h4>
                    <ul>
                        <li><a href="/">Beranda</a></li>
                        <li><a href="/pages/kelas-10.html">Kelas 10</a></li>
                        <li><a href="/pages/kelas-11.html">Kelas 11</a></li>
                        <li><a href="/pages/kelas-12.html">Kelas 12</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="/pages/quiz.html">Quiz</a></li>
                        <li><a href="/pages/forum.html">Forum</a></li>
                        <li><a href="/pages/lab-virtual.html">Lab Virtual</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Edunet. All rights reserved.</p>
                <p class="footer-tagline">PJBL Kelompok 2 TKJ</p>
            </div>
        </div>
    </footer>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-overlay"></div>
        <div class="search-container">
            <div class="search-header">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-input" placeholder="Cari materi..." id="searchInput">
                <kbd class="search-kbd">ESC</kbd>
            </div>
            <div class="search-results" id="searchResults">
                <div class="search-hint">
                    <p>Mulai ketik untuk mencari materi...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #errorState {
            display: none !important;
        }

        #errorState.show {
            display: flex !important;
        }
    </style>

    <script type="module">
        // Supabase Integration
        import { getMaterialById } from '../src/supabase/repository.js';
        import { isLoggedIn } from '../src/supabase/auth.js';

        const loadingState = document.getElementById('loadingState');
        const contentContainer = document.getElementById('contentContainer');
        const errorState = document.getElementById('errorState');
        const materialHeader = document.getElementById('materialHeader');
        const materialArticle = document.getElementById('materialArticle');
        const materialSidebar = document.getElementById('materialSidebar');
        const materialNav = document.getElementById('materialNav');

        // Main Error Hander - Removed for production

        async function init() {
            try {
                // Get ID from URL
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');

                if (!id) {
                    showError();
                    return;
                }

                await loadMaterial(id);
            } catch (err) {
                console.error('Init error:', err);
                showErrorDetails(err.message);
            }
        }

        // Start
        init();

        function showErrorDetails(msg) {
            loadingState.style.display = 'none';
            if (errorState) {
                errorState.classList.add('show');
                const p = errorState.querySelector('p');
                if (p) p.textContent = `Error: ${msg}`;
            }
        }

        async function loadMaterial(id) {
            try {
                const material = await getMaterialById(id);

                if (!material) {
                    showError();
                    return;
                }

                document.title = `${material.title} - Edunet`;

                // Get YouTube embed URL
                let videoEmbed = null;
                if (material.videourl) {
                    const videoId = extractYoutubeId(material.videourl);
                    if (videoId) {
                        videoEmbed = `https://www.youtube-nocookie.com/embed/${videoId}`;
                    }
                }

                // Build breadcrumb path
                const specPath = material.spesialisasi
                    ? `/pages/kelas-${material.kelas}/${material.spesialisasi.toLowerCase()}.html`
                    : `/pages/kelas-${material.kelas}.html`;

                // Format date
                const updateDate = material.updated_at
                    ? new Date(material.updated_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })
                    : new Date(material.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });

                // Render Header
                materialHeader.innerHTML = `
                <div class="container">
                    <nav class="breadcrumb">
                        <a href="/">Beranda</a>
                        <i class="bi bi-chevron-right"></i>
                        <a href="/pages/kelas-${material.kelas}.html">Kelas ${material.kelas}</a>
                        ${material.spesialisasi ? `
                            <i class="bi bi-chevron-right"></i>
                            <a href="${specPath}">${material.spesialisasi}</a>
                        ` : ''}
                        <i class="bi bi-chevron-right"></i>
                        <span>${material.title}</span>
                    </nav>

                    <div class="material-header-content">
                        <div class="material-badge">
                            <i class="bi bi-folder2-open"></i>
                            <span>${material.spesialisasi || ''} Kelas ${material.kelas}${material.modul ? ` - ${material.modul}` : ''}</span>
                        </div>
                        <h1 class="material-title">${material.title}</h1>
                        <p class="material-subtitle">${material.deskripsi}</p>
                        <div class="material-meta-info">
                            <span class="meta-item">
                                <i class="bi bi-clock"></i>
                                ${material.durasi || 30} menit
                            </span>
                            <span class="meta-item">
                                <i class="bi bi-bar-chart"></i>
                                ${material.tingkat || 'Menengah'}
                            </span>
                            <span class="meta-item">
                                <i class="bi bi-calendar3"></i>
                                Update: ${updateDate}
                            </span>
                        </div>
                    </div>
                </div>
            `;

                // Render Article Content
                materialArticle.innerHTML = `
                <section class="article-section">
                    ${material.konten ? material.konten : `<p>${material.deskripsi}</p>`}
                </section>
            `;

                // Render Sidebar
                // Render Sidebar
                let resourcesHtml = '';
                if (material.pdfurl || material.jobsheeturl || material.essay_pdf_url) {
                    resourcesHtml = `
                    <div class="sidebar-card resources-card">
                        <h3><i class="bi bi-folder2"></i> Resources</h3>
                        <div class="resource-buttons">
                            ${material.pdfurl ? `
                                <a href="${material.pdfurl}" class="resource-btn pdf-btn" target="_blank">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                    <div class="resource-info">
                                        <span class="resource-title">Modul PDF</span>
                                        <span class="resource-size">Download</span>
                                    </div>
                                    <i class="bi bi-download"></i>
                                </a>
                            ` : ''}
                            ${material.jobsheeturl ? `
                                <a href="${material.jobsheeturl}" class="resource-btn jobsheet-btn" target="_blank">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <div class="resource-info">
                                        <span class="resource-title">Jobsheet (cara kerja)</span>
                                        <span class="resource-size">Download</span>
                                    </div>
                                    <i class="bi bi-download"></i>
                                </a>
                            ` : ''}
                            ${material.essay_pdf_url ? `
                                <a href="${material.essay_pdf_url}" class="resource-btn" target="_blank" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.2);">
                                    <i class="bi bi-journal-text"></i>
                                    <div class="resource-info">
                                        <span class="resource-title">Soal Essay</span>
                                        <span class="resource-size">Download</span>
                                    </div>
                                    <i class="bi bi-download"></i>
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
                }

                let videoHtml = '';
                if (videoEmbed) {
                    videoHtml = `
                    <div class="sidebar-card video-card">
                        <h3><i class="bi bi-play-circle"></i> Video Tutorial</h3>
                        <div class="video-wrapper">
                            <iframe src="${videoEmbed}" title="Tutorial ${material.title}"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen>
                            </iframe>
                        </div>
                        <p class="video-caption">
                            <i class="bi bi-info-circle"></i>
                            Video tutorial ${material.title}
                        </p>
                    </div>
                `;
                }

                materialSidebar.innerHTML = `
                ${resourcesHtml}
                ${videoHtml}
            `;

                // Render Navigation
                materialNav.innerHTML = `
                <div class="container">
                    <div class="nav-buttons">
                        <a href="${specPath}" class="nav-btn list-btn">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Semua Materi</span>
                        </a>
                    </div>
                </div>
            `;

                // Show content
                loadingState.style.display = 'none';
                contentContainer.style.display = 'block';

                // Add Quiz Link Button if material has quiz data
                if (material.quiz_data && material.quiz_data.length > 0) {
                    const sidebar = document.getElementById('materialSidebar');
                    if (sidebar) {
                        const quizCard = document.createElement('div');
                        quizCard.className = 'sidebar-card';
                        quizCard.style.borderTop = '3px solid var(--accent-primary)';
                        quizCard.innerHTML = `
                            <h3><i class="bi bi-patch-question-fill" style="color: var(--accent-primary);"></i> Kuis Materi</h3>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                Uji pemahamanmu dengan ${material.quiz_data.length} soal.
                            </p>
                            <a href="/pages/quiz.html?kelas=${material.kelas}" class="btn btn-primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; text-decoration: none;">
                                <i class="bi bi-play-circle"></i> Mulai Kuis
                            </a>
                        `;
                        sidebar.appendChild(quizCard);
                    }
                }
            } catch (error) {
                console.error('Error loading material:', error);
                showErrorDetails(error.message);
            }
        }

        function showError() {
            loadingState.style.display = 'none';
            errorState.classList.add('show');
        }

        function extractYoutubeId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }
    </script>

    <script>
        // Copy code functionality
        function copyCode(button) {
            const codeBlock = button.closest('.code-block');
            const code = codeBlock.querySelector('code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                button.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => {
                    button.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        }
    </script>



    <script type="module" src="/src/main.js"></script>
</body>

</html>